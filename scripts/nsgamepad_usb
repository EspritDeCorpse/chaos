# Created by https://github.com/milador/RaspberryPi-Joystick
#!/bin/bash
# This must run as root!
# This creates a generic gamepad with 2 sticks, 1 dpad, and 14 buttons.

#sleep 30

# Create nsgamepad gadget
cd /sys/kernel/config/usb_gadget/
mkdir -p nsgamepad
cd nsgamepad

# Define USB specification
#echo 0x1d6b > idVendor # Linux Foundation
#echo 0x0104 > idProduct # Gamepad
#echo 0x0100 > bcdDevice # v1.0.0
#echo 0x0101 > bcdUSB # USB2
#echo 0x00 > bDeviceClass
#echo 0x00 > bDeviceSubClass
#echo 0x00 > bDeviceProtocol

# Define USB specification PS5
#echo 0x054c > idVendor # Sony Corp.
#echo 0x0ce6 > idProduct # 
#echo 0x0100 > bcdDevice # v1.0.0
#echo 0x0101 > bcdUSB # USB2
#echo 0x00 > bDeviceClass
#echo 0x00 > bDeviceSubClass
#echo 0x00 > bDeviceProtocol

# Define USB specification PS4
echo 0x054c > idVendor # Sony Corp.
echo 0x09cc > idProduct # 
echo 0x0100 > bcdDevice # v1.0.0
echo 0x0101 > bcdUSB # USB2
echo 0x00 > bDeviceClass
echo 0x00 > bDeviceSubClass
echo 0x00 > bDeviceProtocol

# Perform localization
mkdir -p strings/0x409

#echo "Raspberry Pi" > strings/0x409/manufacturer
#echo "NSGamepad" > strings/0x409/product
echo "Sony Interactive Entertainment" > strings/0x409/manufacturer
#echo "Wireless Controller" > strings/0x409/product
echo "DualShock 4 [CUH-ZCT2x]" > strings/0x409/product

# Define the functions of the device
mkdir functions/uac1.usb0
#echo 0 > functions/hid.usb0/protocol
#echo 2 > functions/hid.usb0/subclass
#echo 8 > functions/hid.usb0/report_length
#echo 64 > functions/hid.usb0/report_length
echo 32000 > functions/uac1.usb0/c_srate
echo 16000 > functions/uac1.usb0/p_srate
echo 1 > functions/uac1.usb0/p_chmask

mkdir functions/hid.usb1
echo 0 > functions/hid.usb1/protocol
echo 0 > functions/hid.usb1/subclass
#echo 8 > functions/hid.usb1/report_length
echo 64 > functions/hid.usb1/report_length


mkdir functions/hid.usb2
echo 0 > functions/hid.usb2/protocol
echo 0 > functions/hid.usb2/subclass
#echo 8 > functions/hid.usb2/report_length
echo 64 > functions/hid.usb2/report_length

# Define the functions of the device
mkdir functions/hid.usb3
echo 0 > functions/hid.usb3/protocol
echo 0 > functions/hid.usb3/subclass
#echo 8 > functions/hid.usb3/report_length
echo 64 > functions/hid.usb3/report_length

# Write report descriptor ( 2 analog sticks, 1 dpad, 14 buttons )
#echo "05010905a10115002501350045017501950e05091901290e81029502810105012507463b017504950165140939814265009501810126ff0046ff000930093109320935750895048102750895018101c0" | xxd -r -ps > functions/hid.usb3/report_desc

# PS5:
#echo "05010905a1018501093009310932093509330934150026ff007508950681020600ff09209501810205010939150025073500463b016514750495018142650005091901290f150025017501950f81020600ff0921950d81020600ff0922150026ff0075089534810285020923952f9102850509339528b10285080934952fb102850909249513b102850a0925951ab10285200926953fb102852109279504b10285220940953fb10285800928953fb10285810929953fb1028582092a9509b1028583092b953fb1028584092c953fb1028585092d9502b10285a0092e9501b10285e0092f953fb10285f00930953fb10285f10931953fb10285f20932950fb10285f40935953fb10285f509369503b102c0" | xxd -r -ps > functions/hid.usb3/report_desc

#PS4:
echo "05010905a10185010930093109320935150026ff007508950481020939150025073500463b016514750495018142650005091901290e150025017501950e81020600ff0920750695011500257f8102050109330934150026ff007508950281020600ff09219536810285050922951f9102850409239524b102850209249524b102850809259503b102851009269504b102851109279502b10285120602ff0921950fb102851309229516b10285140605ff09209510b10285150921952cb1020680ff858009209506b102858109219506b102858209229505b102858309239501b102858409249504b102858509259506b102858609269506b102858709279523b102858809289522b102858909299502b102859009309505b102859109319503b102859209329503b10285930933950cb10285a009409506b10285a109419501b10285a209429501b10285a309439530b10285a40944950db10285a509459515b10285a609469515b10285f00947953fb10285f10948953fb10285f20949950fb10285a7094a9501b10285a8094b9501b10285a9094c9508b10285aa094e9501b10285ab094f9539b10285ac09509539b10285ad0951950bb10285ae09529501b10285af09539502b10285b00954953fb10285b109559502b10285b209569502b10285e009579502b10285b30955953fb10285b40955953fb102c0" | xxd -r -ps > functions/hid.usb3/report_desc

echo "05010905a10185010930093109320935150026ff007508950481020939150025073500463b016514750495018142650005091901290e150025017501950e81020600ff0920750695011500257f8102050109330934150026ff007508950281020600ff09219536810285050922951f9102850409239524b102850209249524b102850809259503b102851009269504b102851109279502b10285120602ff0921950fb102851309229516b10285140605ff09209510b10285150921952cb1020680ff858009209506b102858109219506b102858209229505b102858309239501b102858409249504b102858509259506b102858609269506b102858709279523b102858809289522b102858909299502b102859009309505b102859109319503b102859209329503b10285930933950cb10285a009409506b10285a109419501b10285a209429501b10285a309439530b10285a40944950db10285a509459515b10285a609469515b10285f00947953fb10285f10948953fb10285f20949950fb10285a7094a9501b10285a8094b9501b10285a9094c9508b10285aa094e9501b10285ab094f9539b10285ac09509539b10285ad0951950bb10285ae09529501b10285af09539502b10285b00954953fb10285b109559502b10285b209569502b10285e009579502b10285b30955953fb10285b40955953fb102c0" | xxd -r -ps > functions/hid.usb2/report_desc

# Create configuration file
mkdir configs/c.1
mkdir configs/c.1/strings/0x409


echo 0xc0 > configs/c.1/bmAttributes
echo 500 > configs/c.1/MaxPower # 500 mA


# Link the configuration file
ln -s functions/uac1.usb0 configs/c.1
ln -s functions/hid.usb1 configs/c.1
ln -s functions/hid.usb2 configs/c.1
ln -s functions/hid.usb3 configs/c.1


# Activate device
ls /sys/class/udc > UDC

#sleep 30
